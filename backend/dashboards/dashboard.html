<!DOCTYPE html>
<html>
<head>
    <title>ResiliNet | Admin Dashboard</title>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f4f4f4; margin: 0; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #map { height: 500px; width: 100%; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .alert-box { margin-top: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .alert-item { border-bottom: 1px solid #eee; padding: 10px 0; margin: 0; }
        .alert-item:last-child { border-bottom: none; }
        .btn-clear { padding: 12px 20px; background: #e63946; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.3s; }
        .btn-clear:hover { background: #b92e3a; }
    </style>
</head>
<body>

    <header>
        <h1>üõ∞Ô∏è ResiliNet Strategic Admin</h1>
        <button class="btn-clear" onclick="resetDatabase()">Empty Database</button>
    </header>
    
    <div id="map"></div>
    
    <div class="alert-box">
        <h3>Live Intelligence Feed</h3>
        <div id="alert-list">Waiting for signals...</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Initialize Map
        const map = L.map('map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        let markers = L.layerGroup().addTo(map);

        // Fetch Alerts from Backend
        async function fetchAlerts() {
            try {
                // API_URL comes from config.js
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Server not responding");
                
                const data = await res.json();
                
                // Clear existing UI elements
                markers.clearLayers();
                const listDiv = document.getElementById('alert-list');
                listDiv.innerHTML = "";

                if (data.length === 0) {
                    listDiv.innerHTML = "<p style='color: #666;'>No active SOS alerts found.</p>";
                    return;
                }

                data.forEach(alert => {
                    // 1. Add Marker to Map
                    if (alert.location && alert.location.latitude) {
                        L.marker([alert.location.latitude, alert.location.longitude])
                            .addTo(markers)
                            .bindPopup(`<b>User: ${alert.userId}</b><br>Type: ${alert.category}<br>Status: ${alert.status}`);

                        // 2. Add Item to Sidebar List
                        const p = document.createElement('p');
                        p.className = 'alert-item';
                        const time = new Date(alert.timestamp).toLocaleTimeString();
                        p.innerHTML = `üö® <b>${alert.userId}</b> - <span style="color: #e63946;">${alert.category.toUpperCase()}</span> <small style="float:right; color:#888;">${time}</small>`;
                        listDiv.appendChild(p);
                    }
                });
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // Clear Database Function
        async function resetDatabase() {
            if (confirm("‚ö†Ô∏è WARNING: This will permanently delete all SOS records from the database. Proceed?")) {
                try {
                    // CLEAR_URL comes from config.js
                    const response = await fetch(CLEAR_URL, { method: 'DELETE' }); 
                    
                    if (response.ok) {
                        alert("‚úÖ Database cleared successfully!");
                        fetchAlerts(); // Refresh UI without full page reload
                    } else {
                        alert("‚ùå Failed to clear database. Check server logs.");
                    }
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("üì° Network error: Could not reach the server.");
                }
            }
        }

        // Refresh cycle every 5 seconds
        setInterval(fetchAlerts, 5000);
        
        // Initial load
        fetchAlerts();
    </script>
</body>
</html>